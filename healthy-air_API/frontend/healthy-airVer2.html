<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Healthy-Air</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="healthy-airVer2.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="healthy-air.js"></script>
</head>

<body>
    <header class="header">
        <div class="header__inner">
            <img class="header__logo" src="img/pic_iaq.jpg" alt="Healthy-Air Building">
            <h1 class="header__title">
                Healthy-Air
            </h1>
            <h5 style="padding: 0 0 1rem 20rem;">
                Improving indoor air quality
            </h5>
        </div>
    </header>

    <nav id="drawer" class="nav">
        <ul class="nav__list">
            <li class="nav__item"><a href="#">Home</a></li>
            <li class="nav__item"><a href="#">Pollutants</a></li>
            <li class="nav__item"><a href="#">Analytics</a></li>
            <li class="nav__item"><a href="#">About</a></li>
        </ul>
    </nav>

    <main>
        <section class="content">
            <section class="hero">
                <article class="description">
                    <h2>Enabling high-quality indoor air in every home!</h2>
                </article>
            </section>

            <section class="scores">
                <table class="scores__table">
                    <caption id="caption"> </caption>
                    <thead>
                        <tr>
                            <th>Pollutants</th>
                            <th>Current readings</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="iaq">
                            <td id="iaq">IAQ</td>
                            <td>45</td>
                            <td>Good</td>
                        </tr>
                        <tr class='live'>
                            <td id="PM2.5">PM2.5</td>
                            <td>45</td>
                            <td>Good</td>
                        </tr>
                        <tr class='live'>
                            <td id="PM10">PM10</td>
                            <td>45</td>
                            <td>Good</td>
                        </tr>
                        <tr class='live'>
                            <td id="humid">Humidity</td>
                            <td>45</td>
                            <td>Good</td>
                        </tr>
                        <tr class='live'>
                            <td id="pres">Pressure</td>
                            <td>45</td>
                            <td>Good</td>
                        </tr>
                        <tr class='live'>
                            <td id="temp"> Temperature</td>
                            <td>45</td>
                            <td>Good</td>
                        </tr>

                    </tbody>
                </table>
            </section>

            <section class="chart">
                <label for="pollutant"> Pollutant:</label>
                <select name="pollutant" id="pollutant" onchange="getChartData()">
                    <option value="IAQ" selected> IAQ </option>
                    <option value="PM1.0"> PM1.0 </option>
                    <option value="PM2.5"> PM2.5 </option>
                    <option value="PM10.0"> PM10.0 </option>
                    <option value="Temperature"> Temperature </option>
                    <option value="Humidity"> Pressure</option>
                </select>

                <label for="date" style="margin-left: 15px;"> Date:</label>
                <input name="datePicker" id="datePicker" type="date" onchange="getChartData();"
                    onfocus="this.selectedIndex = -1;" min="2020-09-01">

                <div id="chartContainer"><canvas id="myChart" style="width: 100%;height: 100%;"></canvas></div>

            </section>


            <section class="predict">
                <table class="scores__table">
                    <thead>
                        <tr>
                            <th colspan="3">Get a 3-day forecast </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="forecast-day">
                            <td class="forecast-date"></td>
                            <td> 45</td>
                        </tr>
                        <tr>
                            <td class="forecast-date"></td>
                            <td>45</td>
                        </tr>
                        <tr>
                            <td class="forecast-date"></td>
                            <td>45</td>
                        </tr>
                    </tbody>
                </table>

            </section>

        </section>
        <footer class="footer">
            <ul>
                <li><a href="#">Contact us</a></li>
                <li><a href="#">Follow us on Twitter</a></li>
            </ul>
            <small> &copy; Copyright 2020, Noveltric</small>
        </footer>
    </main>

    <script>
        // set restrictions & default value for date input element
        document.getElementById('datePicker').value = new Date().toLocaleDateString('en-CA');
        document.getElementById('datePicker').max = new Date().toLocaleDateString('en-CA')

        // set up chart data
        const getChartData = () => {
            const pollutant = document.getElementById("pollutant").value;
            const datePicker = document.getElementById("datePicker").value;

            // setup variable to extract PM2.5 data for IAQ calculation
            let tempPol;
            if (pollutant == "IAQ") {
                tempPol = "PM2.5"
            }
            else {
                tempPol = pollutant
            }

            fetch('http://127.0.0.1:5000/pastData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "sensor": 0, "pollutant": tempPol, "reqDate": datePicker })
            })
                .then(rawChartData => rawChartData.json()
                )
                .then(chartData => {
                    console.log(chartData)
                    document.getElementById('myChart').remove() //remove the canvass
                    const canv = document.createElement("canvas")
                    canv.setAttribute("id", "myChart")
                    canv.setAttribute("style", "width: 100%;height: 100%;")
                    document.getElementById('chartContainer').appendChild(canv) //append a new canvas to div container
                    const ctx = document.getElementById('myChart').getContext('2d');
                    chart = new Chart(ctx, {
                        // The type of chart we want to create
                        type: 'line',

                        fill: false,

                        // The data for our dataset
                        data: {
                            labels: chartData["wkDays"],
                            datasets: [{
                                label: pollutant,
                                backgroundColor: 'rgb(255, 99, 132)',
                                borderColor: 'rgb(255, 99, 132)',
                                data: chartData["dataList"],
                                fill: false
                            }],
                        },

                        // Configuration options go here
                        options: {
                            responsive: false,
                            scales: {
                                xAxes: [{
                                    gridLines: {
                                        display: false
                                    }
                                }],
                                yAxes: [{
                                    gridLines: {
                                        // display:false
                                    }
                                }]
                            },
                            maintainAspectRatio: false,
                        }
                    });

                }
                )
                .catch((e) => {
                    console.log('Error: ', e)
                }

                )
        }
        //run at windo load up
        getChartData()
        // set up the date
        const getDate = () => {
            const d = new Date();
            dt = d.toString().slice(0, 10)
            // document.getElementById("caption").innerHTML = "Live readings, " + dt ;
            document.getElementById("caption").innerHTML = "Live readings, " + dt + " " + new Date().toLocaleTimeString();
        }

        setInterval(getDate, 1000)

        const getNextDate = (nextInt) => {
            let currentDate = new Date()
            currentDate.setDate(currentDate.getDate() + parseInt(nextInt))
            return currentDate
        }

        const getDay = () => {
            const weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const tdDate = document.querySelectorAll(".forecast-date");
            for (let i = 0; i < tdDate.length; i++) {
                const nxtDate = getNextDate(i + 1)
                tdDate[i].innerHTML = weekdays[nxtDate.getDay()]
                // const nxtDay = nxtDate.toString().slice(0,)
            }
        }
        getDay()

        function live() {
            fetch('http://127.0.0.1:5000/live')
                .then(response => response.json())
                .then(data => {
                    const liveVal = document.querySelectorAll(".live");
                    console.log(data)
                    const iaq = document.querySelector(".iaq").childNodes[3]
                    iaq.innerHTML = aqiFromPM(parseInt(data["PM2.5"]))

                    for (let i = 0; i < liveVal.length; i++) {
                        param = liveVal[i].childNodes[1].id
                        liveVal[i].childNodes[3].innerHTML = parseFloat(data[param])
                    }
                })
                .catch(function (e) {
                    console.log('Error'.e)
                })
        }

        // initial call to live readings endpoints
        live()

        // call the live readings at 2.5 mins inteerval
        setInterval(live, 150000)



    </script>
</body>

</html>